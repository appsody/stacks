language: go

go:
  - 1.12.x

os:
  - linux

services:
  - docker

# skip the default language's install and script steps, we implement job stages instead
install: skip
script: skip

stages:
  - name: test
  - name: deploy
    if: tag IS present

# script:
#   - . ./ci/build.sh .

get-cli: &get-cli
  install:
      - make get-cli
      - source ci/build.sh .
      - echo $STACKS_LIST
      # hard code the STACKSLIST if testing locally...
      #- export STACKSLIST="incubator/java-microprofile experimental/nodejs-functions incubator/nodejs experimental/nodejs-functions"
      - export STACKSLIST=$STACKS_LIST

test-template: &test-template
  stage: test
  <<: *get-cli
  script: make test      

# note before_deploy will run before each deploy provider
before_deploy:
  - . ./ci/release.sh .

jobs:
  include:
    - <<: *test-template
      name: Stack Tests on Linux
      os: linux
      script: make stack-tests 
    - name: Deploy Release
      deploy:
        stage: deploy
        provider: releases
        skip_cleanup: true
        api_key: $GITHUB_TOKEN
        file: ci/release/*
        file_glob: true
        on:
          tags: true
          repo: appsody/stacks
          branch: master